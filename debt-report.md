# Technical Debt Report

## 1. Outdated Dependencies

### Root Project (`package.json`)
- `dotenv`: `16.4.5` -> `16.5.0` (minor)
- `express`: `4.18.3` -> `5.1.0` (major - requires careful review of migration guide for v5)
- `happy-dom`: `17.4.4` -> `17.6.3` (minor)
- `marked`: `12.0.1` -> `15.0.12` (major - **Security Note:** `marked` does not sanitize HTML output. Use a library like DOMPurify when rendering its output.)
- `openai`: `4.28.4` -> `5.1.1` (major - review changelog for breaking changes)

### Lambda Function (`lambda/package.json`)
- `dotenv`: `16.4.5` -> `16.5.0` (minor)
- `openai`: `4.28.4` -> `5.1.1` (major - review changelog for breaking changes)
- `@aws-sdk/client-lambda`: `3.758.0` -> `3.826.0` (minor) (devDependency)

### Web Application (`webapp/package.json`)
- `@sveltejs/vite-plugin-svelte`: `5.0.3` -> `5.1.0` (minor)
- `svelte`: `5.20.2` -> `5.33.17` (minor - core framework, test thoroughly after update)
- `vite`: `6.2.0` -> `6.3.5` (minor)
- `marked`: `15.0.7` -> `15.0.12` (patch - already updated during inconsistency resolution. **Security Note** applies here too.)

**Recommendation:**
- Prioritize updating major version bumps, especially `express` and `marked` due to potential breaking changes and security implications.
- Update other minor/patch versions as part of regular maintenance.
- For `marked`, ensure DOMPurify or a similar sanitizer is used wherever its output is rendered.

## 2. `marked` Library Inconsistencies

- **Issue:** The project used `marked@12.0.1` in the root and `marked@15.0.7` in `webapp/package.json`.
- **Resolution:** Both instances were updated to `marked@15.0.12`.
- **Security Note:** As mentioned above, `marked` does not sanitize HTML. Implement a sanitizer (e.g., DOMPurify) for all `marked` outputs.
- **Task:** Review all usages of `marked` and integrate a sanitizer.

## 3. Lambda Build Process

- **Issue:** The original Lambda build process in `lambda/package.json` involved manual `cp` commands, making it error-prone and less efficient.
- **Resolution:**
    - Added `esbuild` as a devDependency.
    - The `build` script was updated to use `esbuild` to bundle `lambda.js` and its local dependencies into `dist/index.js`.
    - Dependencies like `aws-sdk`, `@aws-sdk/client-lambda`, `openai`, and `dotenv` are correctly externalized from the bundle.
    - Static assets (`../files`) are copied to `dist/files`.
    - `package.json` is copied to `dist/`, and `npm install --omit=dev` is run in `dist/` to install only production dependencies.
- **Benefit:** More robust, efficient, and smaller Lambda deployment package.
- **Task:** No immediate follow-up tasks for the build process itself, but ensure `lambda.js` correctly imports dependencies for `esbuild` to resolve them.

## 4. Linting and Formatting

- **Enhancement:** Introduced ESLint for linting and Prettier for code formatting to improve code quality and consistency.
- **Details:**
    - Added `eslint`, `prettier`, `eslint-plugin-svelte`, `eslint-config-prettier` as devDependencies.
    - Created `.eslintrc.json` configured for Node.js, browser, ES2021, and Svelte, extending recommended rule sets and Prettier integration.
    - Created `.prettierrc.json` with standard formatting rules (tabWidth: 2, semi: true, singleQuote: true, trailingComma: 'es5').
    - Added `lint` and `format` scripts to the root `package.json`.
    - Created `.eslintignore` and `.prettierignore` files to exclude build outputs and `node_modules`.
- **Task:**
    - Run `npm run lint -- --fix` and `npm run format` to apply the new rules across the existing codebase.
    - Integrate these checks into a pre-commit hook or CI pipeline to maintain consistency.

## 5. Test Coverage Assessment

- **Current Status:**
    - Jest is configured in the root project (`jest.config.js`, `ai-chat.test.js`).
    - No automated coverage reports are generated by default.
    - Tests for `isRelevant` in `ai-chat.test.js` are currently skipped.
    - No testing frameworks or tests are present in `lambda/` or `webapp/`.
- **Recommendations & Tasks:**
    - **General (Root Project):**
        - Modify the `test` script in `package.json` to `node --experimental-vm-modules node_modules/jest/bin/jest.js --coverage`.
        - Update `jest.config.js` to include `collectCoverage: true` and `coverageDirectory: "coverage"`.
        - Unskip the tests for `isRelevant` in `ai-chat.test.js`. Investigate reasons for skipping (e.g., flakiness, external dependencies) and refactor or mock dependencies as needed.
    - **Lambda Function (`lambda/`):**
        - **Task:** Add Jest (or another preferred test runner) to `lambda/package.json`.
        - **Task:** Write unit tests for `lambda.js`, focusing on core logic and mocking any AWS service interactions.
    - **Web Application (`webapp/`):**
        - **Task:** Add Vitest (recommended due to Vite usage) or configure Jest with Svelte support in `webapp/package.json`.
        - **Task:** Write unit tests for Svelte components (props, events, slots).
        - **Task:** Write unit tests for JavaScript modules like `webapp/src/lib/aiService.js`.
    - **Other Core Files (e.g., `server.js`, `fetch-*.js`, `file-search/*.js`):**
        - **Task:** Review and add unit tests for their core functionalities.
        - **Task:** For `server.js`, consider adding API/integration tests (e.g., using `supertest`).

This report summarizes identified technical debt and provides actionable tasks for improvement.
